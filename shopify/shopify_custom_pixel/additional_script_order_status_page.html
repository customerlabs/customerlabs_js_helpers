<script id="cl_additional_order_status_script" type="text/javascript">
    var clearObject = function(obj){
        var newObj = Object.assign({}, obj)
        for (const key in newObj) {
            var element = newObj[key];
            if (typeof element == "string") {
                if (element.length == 0) {
                    delete newObj[key];
                }
            }
            if (!element) {
                delete newObj[key];
            }
        }
        return newObj;
    };
    window.clShopifyTrack = function(){
        {% unless post_purchase_page_accessed %}
            {% if first_time_accessed %}

                var checkout_billing_address = clearObject({{checkout.billing_address | json}} || {});
                var checkout_shipping_address = clearObject({{checkout.shipping_address | json}} || {});
                var order_billing_address = clearObject({{order.billing_address | json}} || {});
                var order_shipping_address = clearObject({{order.shipping_address | json}} || {});

                var checkout_address = Object.assign({}, checkout_billing_address, checkout_shipping_address);
                var order_address = Object.assign({}, order_billing_address, order_shipping_address);


                var cltraits = Object.assign({}, checkout_address, order_address);

                cltraits["email"] = {{order.email | json}} || {{checkout.email | json}};

                if(cltraits["email"]){
                    var user_traits = {}
                    for(var trait in cltraits){
                        if(cltraits[trait]){
                            user_traits[trait] = {
                                "t": "string",
                                "v": cltraits[trait]
                            }
                        }
                    }
                    var props = {
                        "customProperties": {
                            "user_traits": {
                                "t": "Object",
                                "v": user_traits
                            },
                            "identify_by_email": {
                                "t":"string",
                                "v": cltraits["email"],
                                "ib": true
                            }
                        }
                    }
                    _cl.identify(props)
                }
            {% endif %}
        {% endunless %}
            
    }
</script>